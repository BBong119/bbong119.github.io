{%- assign targetPath = include.curPath | append: include.targetRelativePath -%}
{%- assign validTreeFiles = site.treefile_array | split: " " -%}

{%- assign targetVer = include.ver -%}
{%- if include.ver == "latest version" -%}
        {%- assign targetVer = "10000" -%}
{%- endif -%}

{%- assign nearestFile = "" -%}
{%- assign findTargetFile = false -%}
{%- assign nearestVer = "10000" -%}
{%- assign nearestVerDiff = 10000 -%}

{%- for treeFile in validTreeFiles -%}
        {%- assign curTreeFileVer = "10000" -%}
        {%- assign matchUrl = treeFile -%}
        {%- if treeFile contains '-v' -%}
                {%- assign curTreeFileVer = treeFile |  split: '-v' | last | split: '/' | first | replace: '.html', '' | rstrip -%}
                {%- assign matchUrl = treeFile | remove: '-v' | remove: curTreeFileVer | rstrip -%}
        {%- endif -%}
        {%- if matchUrl == targetPath -%}
                {{ matchUrl }}
                {%- if targetVer == curTreeFileVer -%}
                        {%- assign nearestFile = treeFile -%}
                        {%- assign findTargetFile = true -%}
                        {%- break -%}
                {%- else -%}
                        {%- assign verDiff = 10000 -%}
                        {%- assign validVer = false -%}
                        {%- assign needCheckSize = true -%}
                        {%- assign targetVerArray = targetVer | split:'.' -%}
                        {%- assign curTreeFileVerArray = curTreeFileVer | split:'.' -%}
                        {%- assign minSize = targetVerArray.size -%}
                        {%- if curTreeFileVerArray.size < minSize -%}
                                {%- assign minSize = curTreeFileVerArray.size -%}
                        {%- endif -%}
                        {%- for i in (0..minSize-1) -%}
                                {{ curTreeFileVerArray[i] }}
                                {{ targetVerArray[i] }}
                                {%- if curTreeFileVerArray[i] > targetVerArray[i] -%}
                                        {%- assign verDiff = 1 / (10*i) * (curTreeFileVerArray[i] - targetVerArray[i]) -%}
                                        {%- assign validVer = true -%}    
                                        {%- break -%}
                                {%- elsif curTreeFileVerArray[i] < targetVerArray[i] -%}
                                        {%- assign needCheckSize = false -%}
                                {%- endif -%}
                        {% endfor %}
                        {%- unless validVer -%}
                                {%- if needCheckSize and curTreeFileVerArray.size > targetVerArray.size -%}
                                        {%- assign validVer = true -%}
                                        {%- assign verDiff = 1 / (10*minSize) * curTreeFileVerArray[minSize] -%}   
                                {%- endif -%}
                        {% endunless %}
                        
                        {%- if validVer -%}
                                {{ treeFile }}
                                {%- if findTargetFile -%}
                                        {%- if verDiff < nearestVerDiff -%}
                                                {%- assign nearestFile = treeFile -%}
                                                {%- assign nearestVer = curTreeFileVer -%}
                                                {%- assign nearestVerDiff = verDiff -%}
                                        {%- endif -%}
                                {%- else -%}
                                        {%- assign nearestFile = treeFile -%}
                                        {%- assign nearestVer = curTreeFileVer -%}
                                        {%- assign nearestVerDiff = verDiff -%}
                                        {%- assign findTargetFile = true -%}
                                {%- endif -%}
                        {%- endif -%}
                {%- endif -%}
        {%- endif -%}
{%- endfor -%}

{%- if findTargetFile -%}
        {%- assign relativePath = nearestFile | remove: include.curPath -%}
        {%- assign curDirPath = "" -%}
        {%- if nearestFile contains '/' -%}
                {%- assign needRemoveStr = nearestFile |  split: '/' | last | rstrip -%}
                {%- assign currentPath = page.url | remove: needRemoveStr -%}
        {%- endif -%}
        {%- include {{ relativePath }} ver=include.ver curPath=curDirPath -%}
{%- endif -%}